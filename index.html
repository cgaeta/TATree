<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test</title>
  <script type="text/javascript" src="js/d3.js"></script>
  <style>
    #view {
      margin: 20px 0 20px 5%;
      width: 40%;
      height: 640px;
      overflow: auto;
      display: inline-block;
    }
    
    #script {
      margin: 20px 5% 20px 0;
      width: 40%;
      max-height: 640px;
      overflow-y: scroll;
      display: inline-block;
    }
    
    #json {
      white-space: pre;
      height: 80px;
      overflow: auto;
    }
    
    .link {
      fill: none;
      stroke: #888888;
    }
    
    .highlightText {
      background-color: rgba(255, 255, 0, .7);
    }
    
    .hidden {
      opacity: 0;
    }
    
    .node {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      cursor: pointer;
    }
    
    .collapsedParent .node-dot {
      fill: #FFFFFF;
      stroke: #444444;
    }
    
    .collapsedParent text {
      font-size: 18pt;
    }
    
    .node-dot {
      r: 5;
    }
    
  </style>
</head>
<body>
  <label>JSON file to analyze:</label>
  <input type="file" id="fileField" />
  <label>Add transcript</label>
  <input type="file" id="transcriptField" />
  <button id="showTranscript">Show next transcript</button>
  <button id="encodeSelection">Encode selection</button>
  <form>
    <label>Add node</label>
    <input type="text" id="nodeField" />
    <input type="submit" value="Insert" id="insertNode" />
  </form>
  <div id="view"></div>
  <div id="script"></div>
  <label>Click below to copy JSON</label>
  <p id="json"></p>
  <script type="text/javascript">
    
    var data = null;
    var transcripts = [];
    
    var currTransc = 0;
    
    var z = 0;
    var total = 0;
    var nodeDepths = [];
    var strLen = 0;
    
    var dragging = null;
    var selected = null;
    var highlighted = null;
    
    var dragStEvent = null;
    
    var dragListener = d3.behavior.drag()
      .on("dragstart", function(d){
        if(d.parent == null) return;
        dragStEvent = d3.event;
      })
      .on("drag", function(d){
        if(d.parent == null) return;
        d.x0 += d3.event.dy;
        d.y0 += d3.event.dx;
        var n = d3.select(this);
        n.attr("transform", "translate("+d.y0+","+d.x0+")");
      })
      .on("dragend", function(d){
        if(dragStEvent == null) return;
                
        // simply clicked on a node?
        if((matchTest(selected) || selected === null)){
            
          dragging = null;
          
          var delta = {};
                    
          delta.x = Math.abs(d3.event.sourceEvent.clientX - dragStEvent.sourceEvent.clientX),
            delta.y = Math.abs(d3.event.sourceEvent.clientY - dragStEvent.sourceEvent.clientY);
          
          // clicked near origin - treat event as just a click
          if(delta.x < 5 && delta.y < 5){
            if(this !== highlighted){
              if(highlighted != null){
                d3.select(highlighted)
                  .attr("fill", "#000000");
              }
                //d3.select(highlighted).classed("highlighted", false);
              highlighted = this;
              d3.select(this)
                .attr("fill", "#4499FF");
              
            }
            else{
            	hideChildren(d);
          		d3.select(this).classed("collapsedParent", d._children);
            }
          }
          
          //update(d);
          update(data);
          dragStEvent = null;
          selected = null;
          
          return;
        }
        else{
          
          endDrag(selected);
          update(data);
                              
          return;
        }
        
      });
    
    var tree = d3.layout.tree()
      .sort(null)
      .size([4000, 480])
      .children(function(d){
        return(!d.children || d.children.length === 0) ? null : d.children;
      })
      .separation(function(a, b){
        if(!(hasChildren(a) || hasChildren(b)))
          return a.parent === b.parent ? 1 : 2;
        else
          return a.parent === b.parent ? 3 : 4;
      });
    
    var link = d3.svg.diagonal()
      .projection(function(d){
        return [d.y, d.x];
      });
    
    var layoutRoot = d3.select("#view")
    .append("svg:svg")
    .attr("width", 1600)
    .attr("height", 8000)
    .append("svg:g")
    .attr("class", "container")
    .attr("transform", "translate(60, 0)");
    
    /*
      draw node hierarchy
    */
    function update(source) {
      
      if(source == null && localStorage.data){
        source = JSON.parse(localStorage.getItem("data"));
      
        if(source.transcripts)
          transcripts = source.transcripts;
        
        if(source.data)
          source = source.data;
      }
      else if(source == null) return;
      
      data = source;
      
      var h = 0;
      nodeDepths = [];
      depthCounts(data);
      total = countChildren(data);
      
      var newHeight = d3.max(nodeDepths) * 40;
      newHeight = Math.max(newHeight, 640);
      
      var newWidth = Math.max(strLen * nodeDepths.length, 800);
      
      tree = tree.size([newHeight, newWidth]);
      
      var svgCanvas = document.getElementById("view").firstChild
      svgCanvas.setAttribute("height", newHeight);
      svgCanvas.setAttribute("width", newWidth * 2);

      var nodes = tree.nodes(data);
      var links = tree.links(nodes);
      
      layoutRoot.selectAll("path.link")
        .data(links)
        .enter()
        .append("svg:path")
        .attr("class", "link")
        .attr("d", link);

      var node = layoutRoot.selectAll("g.node")
        .data(nodes, function(d){
          return d.id || (d.id = ++z);
        });
      
      var nodeGroup = node.enter().append("svg:g")
        .call(dragListener)
        .attr("class", function(d){
          return d._children ? "node collapsedParent" : "node";
        })
        .attr("transform", function(d){
          return "translate("+(d.depth * 80)+","+d.x+")";
        })
        .on('mousedown', function(d){
          startDrag(d);
        })
        .on("mouseover", function(d){
          if(dragging && d !== dragging)
            selected = d;
        })
        .on("mouseout", function(d){
          if(dragging && d !== dragging)
              selected = null;
        });
      
      nodeGroup.append("svg:circle")
        .attr("class", "node-dot")
        .attr("r", 5);
      
      nodeGroup.append("svg:text")
        .attr("text-anchor", function(d){
          return d.children ? "end" : "start";
        })
        .attr("dx", function(d){
          var gap = 20;
          return d.children ? -gap : gap;
        })
        .attr("dy", function(d){
          return (d.children) ? -15 : 3;
        })
        .text(function(d){
          return d.name;
        });
      
      var nodeUpdate = node.transition()
        .duration(300)
        .attr("transform", function(d){

          if(d._children){
            d.count = countChildren(d);
            h += d.count / total * 5;
          }
          else
            d.count = 0;
                
        //d.x = 20 + 20 * h++;
        //d.y = 80 * d.depth;
        
        if(total > 0)
          h += d.count / total * 5;
        
        return "translate(" + d.y + "," + d.x + ")";
      });
            
      nodeUpdate.select("circle")
        .attr("r", function(d){
        
          if(d._children){
            d.count = countChildren(d);
          }
          else
            d.count = 0;
        
          return total === 0 ? 5 : 5 + d.count / total * 50;
        });
      
      nodeUpdate.select("text")
        .style("fill-opacity", 1)
        .attr("text-anchor", function(d){
          return d.parent ? d.children ? "end" : "start" : "end";
        })
        .attr("dx", function(d){
          return d.parent ? d.children ? 0 : d._children ? 25 : 20 : -10;
        })
        .attr("dy", function(d){
          return d.parent && d.children ? 15 : 3;
        });
      
      var nodeExit = node.exit().transition()
        .duration(300)
        .attr("style", "hidden")
        .remove();

      nodeExit.select("circle")
        .attr("r", 1e-6);
      
      nodeExit.select("text")
        .style("fill-opacity", 1e-6);
      
      var nuLink = layoutRoot.selectAll("path.link")
        .data(tree.links(nodes), function(d){
          return d.target.id;
        });
      
      nuLink.enter().insert("svg:path", "g")
        .attr("class", "link")
        .attr("d", function(d){
          var o = {x: source.x0, y: source.y0};
          return link({source: o, target: o});
        })
        .transition()
        .duration(300)
        .attr("d", link);
      
      nuLink.transition()
      .duration(300)
      .attr("d", link);
      
      nuLink.exit().transition()
      .duration(300)
      .attr("d", function(d){
        var o = {x: source.x, y: source.y};
      })
      .remove();
      
      nodes.forEach(function(d){
        d.x0 = d.x;
        d.y0 = d.y;
      });
      
      var saveData = {data: getJSON(data), transcripts: transcripts};
      
      document.getElementById("json").innerHTML = JSON.stringify(saveData, null, 4);
      localStorage.setItem("data", JSON.stringify(saveData));
      
    }
    
    /*
      return whether the node has children
    */
    function hasChildren(d){
      return (true && d.children || d._children);
    }
    
    /*
      hide the nodes children
    */
    function hideChildren(d){
      if(!d) return;
      if(d.children){
        d._children = d.children;
        d.children = null;
      }
      else{
        d.children = d._children;
        d._children = null;
      }
            
    }
    
    function iterateNodes(d, fn){
      
      var c = d.children || d._children;
            
      if(c != null || c != undefined)
        for(var i = 0; i < c.length; i++)
          iterateNodes(c[i], fn);
      
      fn(d);
    }
    
    /*
      count the node's children
    */
    function countChildren(d){
      
      if(d == null) return 0;
      
      var c = 0;
      
      if(d.children){
        c = d.children.length;
        
        for(var i = 0; i < d.children.length; i++)
          c += countChildren(d.children[i]);
      }
      else if(d._children){
        c = d._children.length;
        
        for(var i = 0; i < d._children.length; i++)
          c += countChildren(d._children[i]);
      }
      
      return c;
      
    }
    
    function countLeaves(d){
      
      var c = 0;
      
      if(d.children){
        
        for(var i = 0; i < d.children.length; i++)
          c += countLeaves(d.children[i]);
        
        return 0;
        
      }
      
      else
        return 1;
      
    }
    
    function depthCounts(d, l){
      
      if(d == null)
        return 0;
      
      if(!l)
        l = 0;
      			
      strLen = Math.max(strLen, d.name.length);
      
      if(!nodeDepths[l])
        nodeDepths[l] = 1;
      
      else
        nodeDepths[l] += 1;
      
      var ch = d.children;
      
      if(ch){
        for(var i = 0; i < ch.length; i++){
          depthCounts(ch[i], l+1);
        }
      }
      
    }
    
    function startDrag(d){
      dragging = d;
      
      var group = d3.selectAll("g.node").sort(function(a,b){
        if(a.id != dragging.id) return 1;
        else return -1;
      });
    }
    
    function endDrag(d){
            
      if(!d){
        return;
      }
      
      if(isDescendant(d)){
        console.log("Error: cannot move node to descendant node");
        return;
      }
      			
      removeNode(dragging);
      dragging.parent = d;
      
      if(d._children){
        d._children.push(dragging);
      }
      else{
        if(!d.children)
          d.children = [];

        d.children.push(dragging);
      }
      
      selected = null;
      
    }
    
    function removeNode(d){
      var parent = d.parent;
      for(var i = 0; i < parent.children.length; i++){
        if(parent.children[i] == d){
          parent.children.splice(i, 1);
        }
      }
    }
    
    function isDescendant(d){
      
      if(!d) return false;
      
      if(d === dragging)
        return true;
      
      if(d.parent && isDescendant(d.parent))
        return true;
      
      return false;
      
    }
    
    function countPrev(t){
      if(t.previousSibling)
        return countPrev(t.previousSibling) + 1;
      else
        return 0;
    }
    
    function matchTest(d){
      var result = dragging === d;
      return result;
    }
    
    function getJSON(d){
      var ob = {
        "name": d.name,
        "children" : []
      };
            
      if(d.transcript != null){
        ob.transcript = d.transcript;
        ob.el = d.el;
        ob.start = d.start;
        ob.end = d.end;
      }
      
      if(d.children)
        for(var i = 0; i < d.children.length; i++){
          ob.children.push(getJSON(d.children[i]));
        }
      
      if(d._children){
        for(var i = 0; i < d._children.length; i++){
          ob.children.push(getJSON(d._children[i]));
        }
      }
      
      return ob;
    }
    
    function uploadJSON(e){
      var t = e.target || window.event.srcElement;
      var files = t.files;
      
      if(FileReader && files && files.length){
        var fr = new FileReader();
        fr.onload = function(){
          data = JSON.parse(fr.result);
          update(data);
          t.value = "";
        }
        fr.readAsText(files[0]);
      }
    }
    
    function uploadTranscript(e){
      var t = e.target || window.event.srcElement;
      var files = t.files;
      
      if(FileReader && files && files.length){
        var fr = new FileReader();
        fr.onload = function(){
          transcript = fr.result;
          transcripts.push(transcript);
          //update(data);
          t.value = "";
          update(data || {name:"codes", children:{}});
        }
        fr.readAsText(files[0]);
      }
    }
    
    function showTranscript(){
      if(transcripts.length < 1)
        return;
      
      currTransc++;
            
      if(currTransc > transcripts.length - 1)
        currTransc = 0;
            
      var para = transcripts[currTransc].split("\n");
      
      var scr = document.querySelector("#script");
      while(scr.firstChild)
        scr.removeChild(scr.firstChild);
      
      for(var i = 0; i < para.length; i++){
        var p = document.createElement("br");
        scr.appendChild(document.createTextNode(para[i]));
        scr.appendChild(p);
      }
      
      iterateNodes(data, function(d){
        if(d.transcript != currTransc)
          return;
        
        var el = scr.childNodes[d.el];
        
        var r = document.createRange();
        r.setStart(el, d.start);
        r.setEnd(el, d.end);
        
        var sp = document.createElement("span");
        sp.className = "highlightText";
        
        r.surroundContents(sp);
      });
      
    }
    
    function encodeSelection(){
      var text = "";
      if(window.getSelection){
        text = window.getSelection().getRangeAt(0);
      }
      else if(document.selection && document.selection.type != "Control"){
        text = document.selection.createRange();
      }
      
      var selection = {
        name: text.toString(),
        children: [],
        transcript: currTransc,
        el: countPrev(text.startContainer),
        start: text.startOffset,
        end: text.endOffset
      }
      if(highlighted != null)
        addNode(d3.select(highlighted).data()[0], selection);
      else
        addNode(data, selection);
    }
    
    function addNode(parent, node){
      if(parent){
        if(!parent.hasOwnProperty('children'))
          parent.children = [];
              
        parent.children.push(node);
      }
      else
        parent = node;
      
      update(data);
    }
    
    (function(){
      document.getElementById("fileField").addEventListener("change", function(e){
        uploadJSON(e);
      });
      
      document.getElementById("transcriptField").addEventListener("change", function(e){
        uploadTranscript(e);
      });
      
      document.getElementById("showTranscript").addEventListener("click", function(e){
        showTranscript();
      });
      
      document.getElementById("encodeSelection").addEventListener("click", function(e){
        encodeSelection();
      });
      
      document.getElementById("insertNode").addEventListener("click", function(e){
        e.preventDefault();
        var n = document.getElementById("nodeField").value;
        document.getElementById("nodeField").value = "";
        
        if(n && n !== ""){
          var o = {
            "name": n,
            "children": []
          };
          
          if(highlighted != null)
            addNode(d3.select(highlighted).data()[0], o);
          else
            addNode(data, o);
        }
      });
      
      document.getElementById("json").addEventListener("click", function(){
        var range = document.createRange();
        range.selectNodeContents(this);
        var selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
      });
      
      update();
    })();
  </script>
</body>
</html>
